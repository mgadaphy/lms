<!DOCTYPE html>
<html>
<head>
    <title>Profile Completion Test - Fixed Version</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .form-group { margin: 20px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        select, input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 3px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .test-info { background: #e8f5e8; padding: 15px; margin: 10px 0; border-radius: 5px; border: 1px solid #4caf50; }
        .debug-info { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 5px; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <h1>üß™ Profile Completion Test - Fixed Version</h1>
    
    <div class="test-info">
        <h3>‚úÖ Solution Status</h3>
        <p><strong>Problem:</strong> Laravel 500 errors preventing state/city dropdowns from loading</p>
        <p><strong>Solution:</strong> Created standalone PHP endpoints that bypass broken Laravel</p>
        <p><strong>Status:</strong> <span class="success">WORKING - States and cities now load correctly</span></p>
    </div>
    
    <div class="test-info">
        <h3>üß™ Test Instructions</h3>
        <ol>
            <li>Select a country from the dropdown (try Cameroon)</li>
            <li>Verify that states load automatically</li>
            <li>Select a state and verify cities load</li>
            <li>Check browser console for any errors</li>
        </ol>
    </div>
    
    <div class="form-group">
        <label for="country">Country:</label>
        <select id="country" class="select2">
            <option value="">Select Country</option>
            <option value="38">Cameroon</option>
            <option value="39">Canada</option>
            <option value="1">Afghanistan</option>
        </select>
    </div>
    
    <div class="form-group">
        <label for="state">State:</label>
        <select id="state" class="stateList">
            <option value="">Select State</option>
        </select>
    </div>
    
    <div class="form-group">
        <label for="city">City:</label>
        <select id="city" class="cityList">
            <option value="">Select City</option>
        </select>
    </div>
    
    <div class="debug-info">
        <h3>üîç Current Selection</h3>
        <p><strong>Country:</strong> <span id="debug-country">Not selected</span></p>
        <p><strong>State:</strong> <span id="debug-state">Not selected</span></p>
        <p><strong>City:</strong> <span id="debug-city">Not selected</span></p>
    </div>
    
    <div class="log" id="log"></div>
    
    <div class="test-info">
        <h3>üîß Technical Details</h3>
        <p><strong>New Endpoints:</strong></p>
        <ul>
            <li><code>/ajax_states.php</code> - Loads states by country ID</li>
            <li><code>/ajax_cities.php</code> - Loads cities by state ID</li>
        </ul>
        <p><strong>Database Queries:</strong></p>
        <ul>
            <li>States: <code>SELECT id, name FROM states WHERE country_id = ? ORDER BY name</code></li>
            <li>Cities: <code>SELECT id, name FROM spn_cities WHERE state_id = ? ORDER BY name</code></li>
        </ul>
        <p><strong>Response Format:</strong> <code>{"results": [{"id": X, "text": "Name"}], "pagination": {"more": false}}</code></p>
    </div>
    
    <script>
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'success' ? 'success' : type === 'error' ? 'error' : '';
            const className = color ? ` class="${color}"` : '';
            $('#log').append(`<div${className}>[${timestamp}] ${message}</div>`);
            $('#log').scrollTop($('#log')[0].scrollHeight);
        }
        
        $(document).ready(function() {
            log('Page loaded, initializing...');
            
            // Initialize select2
            $('.select2').select2({
                width: '100%'
            });
            
            // Initialize state select2 (without AJAX - we handle it manually)
            $('.stateList').select2({
                width: '100%',
                placeholder: 'Select State'
            });

            // Initialize city select2 (without AJAX - we handle it manually)
            $('.cityList').select2({
                width: '100%',
                placeholder: 'Select City'
            });
            
            // Utility: update debug info
            function updateSelections() {
                let countryText = 'Not selected';
                let stateText = 'Not selected';
                let cityText = 'Not selected';

                // Get country text
                const $country = $('#country');
                if ($country.val()) {
                    const countryData = $country.select2('data');
                    countryText = countryData && countryData[0] ? countryData[0].text : $country.find('option:selected').text();
                }
                // Get state text
                const $state = $('#state');
                if ($state.val()) {
                    const stateData = $state.select2('data');
                    stateText = stateData && stateData[0] ? stateData[0].text : $state.find('option:selected').text();
                }
                // Get city text
                const $city = $('#city');
                if ($city.val()) {
                    const cityData = $city.select2('data');
                    cityText = cityData && cityData[0] ? cityData[0].text : $city.find('option:selected').text();
                }
                $('#debug-country').text(countryText);
                $('#debug-state').text(stateText);
                $('#debug-city').text(cityText);
            }
            
            // Load states when country changes
            $(document).on('change', '#country', function () {
                const countryId = $(this).val();
                const countryName = $(this).find(':selected').text();
                log(`Country changed to: ${countryId} (${countryName})`);
                
                // Clear dependent dropdowns
                $('.stateList').val(null).trigger('change');
                $('.cityList').val(null).trigger('change');
                
                // If country is selected, manually load states via AJAX
                if (countryId) {
                    log(`Loading states for country: ${countryId}`);
                    $.ajax({
                        url: 'http://localhost:8000/ajax_states.php',
                        method: 'GET',
                        data: { id: countryId, search: '' },
                        success: function(data) {
                            log(`States loaded: ${data.results.length} states`, 'success');
                            // Clear and populate state dropdown
                            $('.stateList').html('<option value="">Select State</option>');
                            if (data.results && data.results.length > 0) {
                                data.results.forEach(function(state) {
                                    $('.stateList').append(`<option value="${state.id}">${state.text}</option>`);
                                });
                                log(`Populated state dropdown with ${data.results.length} options`);
                            }
                            updateSelections();
                        },
                        error: function(xhr, status, error) {
                            log(`Failed to load states: ${error}`, 'error');
                            console.error('AJAX Error:', xhr.responseText);
                        }
                    });
                } else {
                    updateSelections();
                }
            });

            // Load cities when state changes
            $(document).on('change', '.stateList', function () {
                const stateId = $(this).val();
                const stateName = $(this).find(':selected').text();
                log(`State changed to: ${stateId} (${stateName})`);
                
                // Clear city dropdown
                $('.cityList').val(null).trigger('change');
                
                // If state is selected, manually load cities via AJAX
                if (stateId) {
                    log(`Loading cities for state: ${stateId}`);
                    $.ajax({
                        url: 'http://localhost:8000/ajax_cities.php',
                        method: 'GET',
                        data: { id: stateId, search: '' },
                        success: function(data) {
                            log(`Cities loaded: ${data.results.length} cities`, 'success');
                            // Clear and populate city dropdown
                            $('.cityList').html('<option value="">Select City</option>');
                            if (data.results && data.results.length > 0) {
                                data.results.forEach(function(city) {
                                    $('.cityList').append(`<option value="${city.id}">${city.text}</option>`);
                                });
                                log(`Populated city dropdown with ${data.results.length} options`);
                            }
                            updateSelections();
                        },
                        error: function(xhr, status, error) {
                            log(`Failed to load cities: ${error}`, 'error');
                            console.error('AJAX Error:', xhr.responseText);
                        }
                    });
                } else {
                    updateSelections();
                }
            });
            
            // On city change
            $(document).on('change', '.cityList', function () {
                updateSelections();
            });
            
            log('Initialization complete. Select a country to test.');
        });
    </script>
</body>
</html>